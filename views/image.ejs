<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>
    <%= image.title || 'Image' %>
  </title>
  <style>
    body {
      margin: 0;
      background: #f5f6fa;
    }

    .body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .photo-wrapper {
      text-align: center;
      margin-bottom: 20px;
    }

    .photo-wrapper img {
      max-width: 100%;
      max-height: 500px;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
    }

    h2 {
      margin: 10px 0;
      color: #333;
      text-align: center;
    }

    .meta {
      margin: 15px 0;
      padding: 12px;
      background: #f1f2f6;
      border-radius: 10px;
      font-size: 15px;
      color: #555;
    }

    .back-btn {
      display: inline-block;
      margin-top: 20px;
      text-decoration: none;
      background: #3498db;
      color: white;
      padding: 10px 18px;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: #2980b9;
    }

    .actions {
      margin-top: 20px;
    }

    .actions a,
    .actions button {
      display: inline-block;
      margin-right: 10px;
      text-decoration: none;
      background: #3498db;
      color: white;
      padding: 10px 18px;
      border-radius: 8px;
      transition: background 0.3s;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î */
    .actions .download-btn {
      background: #27ae60;
    }

    .actions .download-btn:hover {
      background: #1e8449;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
    .actions .edit-btn {
      background: #f1c40f;
    }

    .actions .edit-btn:hover {
      background: #d4ac0d;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö */
    .actions .delete-btn {
      background: #e74c3c;
    }

    .actions .delete-btn:hover {
      background: #c0392b;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      width: 400px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      animation: fadeIn 0.3s;
    }

    .modal-content h2 {
      margin-top: 0;
      text-align: center;
    }

    .modal-content label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      margin-top: 5px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .save-btn {
      margin-top: 15px;
      background: #27ae60;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
    }

    .save-btn:hover {
      background: #1e8449;
    }

    .close {
      float: right;
      font-size: 22px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <%- include('partials/header') %>

    <div class="body">
      <div class="container">
        <% function fmtDate(d){ try { return d ? new
          Date(d).toLocaleString('en-US',{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'})
          : '-' ; } catch(e){ return String(d||'-'); } } %>
          <!-- ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏ç‡πà -->
          <div class="photo-wrapper">
            <% if (image && (image.fileId || image.imageUrl)) { %>
              <% const src=image.fileId ? ('/files/' + image.fileId) : (image.imageUrl || ('/uploads/' +
                image.filename)); %>
                <img src="<%= src %>" alt="<%= image.title || 'image' %>">
                <% } else { %>
                  <p style="color:#999;text-align:center;">Image file not found</p>
                  <% } %>
          </div>

          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ -->
          <h2>
            <%= image.title || 'Untitled' %>
          </h2>
          <div class="meta">
            <p><strong>Content:</strong>
              <%= image.content || "No details" %>
            </p>
            <p><strong>By:</strong>
              <%= (image.user && (image.user.username || image.user.name)) || 'Unknown' %>
            </p>
            <p><strong>Uploaded:</strong>
              <%= fmtDate(image.createdAt) %>
            </p>
          </div>

          <!-- ‡∏õ‡∏∏‡πà‡∏° Action -->
          <% const currentUserId=(typeof user !=='undefined' && user) ? String(user._id || user.id || '' ) : '' ; const
            imageOwnerId=image && image.user ? String(image.user._id || image.user) : '' ; const isOwner=currentUserId
            && imageOwnerId && currentUserId===imageOwnerId; %>

            <div class="actions">
              <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö -->
              <a href="javascript:history.back()" class="back-btn">‚Üê Back</a>

              <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ) -->
              <% const downloadUrl=image.fileId ? ('/files/' + image.fileId + '?download=1' ) : (image.imageUrl ||
                (image.filename ? ('/uploads/' + encodeURIComponent(image.filename)) : '' )); %>
                <a href="<%= downloadUrl %>" download="<%= image.title || image.filename || 'download' %>"
                  class="download-btn">‚¨á Download</a>

                <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏à‡∏∂‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö -->
                <% if (isOwner) { %>
                  <!-- ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà -->
                  <a href="/image/<%= image._id %>/edit" class="edit-btn">‚úé Edit</a>

                  <!-- ‡∏•‡∏ö‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ form + method-override ‡πÄ‡∏õ‡πá‡∏ô fallback -->
                  <form action="/api/upload/images/<%= image._id %>?_method=DELETE" method="POST"
                    style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this image?');">
                    <button type="submit" class="delete-btn">üóë Delete</button>
                  </form>
                  <% } %>
            </div>

      </div>
    </div>
    <!-- Edit Modal -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Edit Image</h2>
        <!-- action="#" to avoid native PUT; JS will send PATCH -->
        <form id="editForm" method="POST" action="#">
          <label>Title</label>
          <input type="text" name="title" value="<%= image.title %>" required>

          <label>Content</label>
          <textarea name="content" rows="4"><%= image.content %></textarea>

          <button type="submit" class="save-btn">üíæ Save</button>
        </form>
      </div>
    </div>

    <!-- scripts: delete + modal + edit handler (must be inside body) -->
    <script>
      // delete handler (uses API route)
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          // if inside a form, allow form submit to handle _method; otherwise use fetch
          const form = btn.closest('form');
          if (form && form.getAttribute('method')?.toUpperCase() === 'POST') {
            // leave native form (method-override) to handle it
            return;
          }
          if (!confirm('Are you sure you want to delete this image?')) return;
          const id = "<%= image._id %>";
          try {
            const res = await fetch(`/api/upload/images/${id}`, {
              method: 'DELETE',
              credentials: 'same-origin',
              headers: { 'Accept': 'application/json' }
            });
            const data = await res.json().catch(() => null);
            if (res.ok) {
              window.location = '/home';
              return;
            }
            alert(data?.error || 'Delete failed');
          } catch (err) {
            console.error(err);
            alert('Network error');
          }
        });
      });

      // modal open/close helpers
      window.openEditModal = () => document.getElementById('editModal')?.style.display = 'block';
      window.closeEditModal = () => document.getElementById('editModal')?.style.display = 'none';
      window.addEventListener('click', (e) => {
        const m = document.getElementById('editModal');
        if (m && e.target === m) window.closeEditModal();
      });
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape') window.closeEditModal(); });

      // edit form: bind with debug logs
      (function () {
        const editForm = document.getElementById('editForm');
        if (!editForm) {
          console.log('editForm not found');
          return;
        }
        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          console.log('editForm submit fired');
          if (!confirm('Save changes?')) { console.log('edit cancelled'); return; }
          const id = "<%= image._id %>";
          const fd = new FormData(editForm);
          try {
            const res = await fetch(`/api/upload/images/${id}`, {
              method: 'PATCH',
              credentials: 'same-origin',
              body: fd,
              headers: { 'Accept': 'application/json' }
            });
            console.log('PATCH response status', res.status);
            const data = await res.json().catch(() => null);
            console.log('PATCH response body', data);
            if (res.ok) {
              window.location = `/image/${id}`;
              return;
            }
            alert(data?.error || 'Update failed');
          } catch (err) {
            console.error('edit error', err);
            alert('Network error');
          }
        });
      })();
    </script>
</body>

</html>